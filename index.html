<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>กิจกรรมที่ 5</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-kKTXQp3+xM7lHGjaH0XYonPcTq7GpQ1Icrsw1uGzD9+y/6u5Lq2IoI7nM9xZyV1gV1t4fM+UqD1jFA6W+FvOA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg,#6a11cb,#2575fc); margin:0; padding:20px; color:#333; }
  h1, h2 { color:#fff; margin-bottom:10px; }
  .container { max-width: 900px; margin:auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.2);}
  input, select, textarea, button { padding:8px; font-size:14px; margin-top:6px; width:100%; box-sizing:border-box; border-radius:6px; border:1px solid #ccc; }
  textarea { resize: vertical; }
  button { cursor:pointer; background:#2575fc; color:#fff; border:none; transition:0.3s; display:flex; align-items:center; gap:6px; justify-content:center; }
  button:hover { background:#1a5bcc; }
  .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .col { flex:1; min-width:120px; }
  .card { border:1px solid #ccc; border-radius:8px; padding:12px; background:#f9f9f9; margin-top:10px; }
  .mini-item { margin-top:6px; background:#eef0ff; padding:6px 8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
  #status { margin-top:10px; font-weight:bold; }
  .muted { color:#555; }
  .success { color:green; }
  .error { color:red; }
  input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  
  /* Responsive */
  @media (max-width:600px){
    .row { flex-direction:column; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>Life Goal Setting</h1>

  <h2>ตั้งค่า Google Sheet</h2>
  <input type="text" id="gasUrl" placeholder="วาง Web App URL ของ GAS ที่นี่">
  <button type="button" onclick="testGas()">ทดสอบการเชื่อมต่อ GAS</button>

  <h2>เป้าหมายใหญ่ของฉันใน 1 ปี</h2>
  <textarea id="bigGoal" placeholder="เช่น: อยากเรียนภาษาอังกฤษให้ได้ 500 คำ"></textarea>

  <h2>เป้าหมายย่อย</h2>
  <input type="text" id="miniInput" placeholder="พิมพ์เป้าหมายย่อยแล้วกดเพิ่ม">
  <button type="button" onclick="addMiniGoal()">เพิ่มเป้าหมายย่อย</button>
  <div id="miniList"></div>

  <h2>จำนวนเดือนติดตาม</h2>
  <input type="number" id="numMonths" value="12" min="1" max="24" onchange="renderMonths()">
  <div id="monthsContainer"></div>

  <h2>คะแนนและการปรับแผน</h2>
  <input type="number" id="overallScore" placeholder="กรอกคะแนนรวม 0-100">
  <input type="text" id="adjustPlan" placeholder="ถ้าต้องปรับแผน ทำอย่างไร">

  <button type="button" onclick="submitForm()">บันทึกและส่งข้อมูล</button>

  <div id="status" class="muted"></div>
  <div id="advice"></div>
</div>

<script>
let GAS_WEB_APP_URL = '';

document.addEventListener('DOMContentLoaded', () => {
  renderMonths();
  const saved = localStorage.getItem('lgs-settings');
  if (saved) {
    try {
      const s = JSON.parse(saved);
      document.getElementById('gasUrl').value = s.gasUrl || '';
      GAS_WEB_APP_URL = s.gasUrl || '';
      const big = s.bigGoal || '';
      if (big) document.getElementById('bigGoal').value = big;
      (s.miniGoals || []).forEach(m => { document.getElementById('miniInput').value = m; addMiniGoal(); });
      document.getElementById('numMonths').value = s.monthsCount || 12;
      renderMonths();
      if (s.monthData) {
        Object.entries(s.monthData).forEach(([i, data]) => {
          const idx = Number(i);
          const completeEl = document.getElementById(`month-complete-${idx}`);
          const percentEl = document.getElementById(`month-percent-${idx}`);
          const adjustEl = document.getElementById(`month-adjust-${idx}`);
          if (completeEl) completeEl.value = data.complete ? 'yes' : 'no';
          if (percentEl) percentEl.value = data.percent || 0;
          if (adjustEl) adjustEl.value = data.adjust || '';
        });
      }
    } catch(e){ console.warn(e); }
  }
});

function renderMonths() {
  const container = document.getElementById('monthsContainer');
  container.innerHTML = '';
  const n = Math.max(1, Math.min(24, Number(document.getElementById('numMonths').value || 12)));
  for (let i = 1; i <= n; i++) {
    const div = document.createElement('div'); 
    div.className = 'card';
    div.innerHTML = `
      <strong>เดือนที่ ${i}</strong>
      <div class="row" style="margin-top:6px">
        <div class="col">
          <label>สำเร็จหรือไม่</label>
          <select id="month-complete-${i}"><option value="yes">ใช่</option><option value="no">ไม่ใช่</option></select>
        </div>
        <div class="col">
          <label>ความคืบหน้า (0-100)</label>
          <input id="month-percent-${i}" type="number" min="0" max="100" value="0">
        </div>
      </div>
      <div style="margin-top:8px">
        <label>ถ้าไม่สำเร็จ ฉันจะปรับแผนโดย:</label>
        <input id="month-adjust-${i}" type="text" placeholder="เช่น: ลดเป้าหมายลงเป็น 30 คำ/เดือน หรือฝึกทุกวันอาทิตย์">
      </div>`;
    container.appendChild(div);
  }
}

function addMiniGoal() {
  const val = document.getElementById('miniInput').value.trim();
  if (!val) return;
  const list = document.getElementById('miniList');
  const idx = list.children.length + 1;
  const item = document.createElement('div'); 
  item.className = 'mini-item';
  item.innerHTML = `<strong>เป้าหมายย่อย ${idx}:</strong> <span class="muted">${escapeHtml(val)}</span> 
                    <button type="button" style="float:right" onclick="this.parentElement.remove();">ลบ</button>`;
  list.appendChild(item);
  document.getElementById('miniInput').value = '';
}

function collectForm() {
  const bigGoal = document.getElementById('bigGoal').value.trim();
  const miniGoals = [...document.getElementById('miniList').children].map(el => el.querySelector('span').innerText);
  const months = {};
  const n = Math.max(1, Math.min(24, Number(document.getElementById('numMonths').value || 12)));
  for (let i=1; i<=n; i++) {
    months[i] = {
      complete: document.getElementById(`month-complete-${i}`).value === 'yes',
      percent: Number(document.getElementById(`month-percent-${i}`).value) || 0,
      adjust: document.getElementById(`month-adjust-${i}`).value || ''
    };
  }
  return {
    bigGoal,
    miniGoals,
    months,
    overallScore: Number(document.getElementById('overallScore').value) || 0,
    adjustPlan: document.getElementById('adjustPlan').value || '',
    submittedAt: new Date().toISOString()
  };
}

async function submitForm(e) {
  e?.preventDefault();
  const data = collectForm();

  // Save local settings
  const settings = {
    gasUrl: document.getElementById('gasUrl').value.trim(),
    bigGoal: data.bigGoal,
    miniGoals: data.miniGoals,
    monthsCount: document.getElementById('numMonths').value,
    monthData: data.months
  };
  localStorage.setItem('lgs-settings', JSON.stringify(settings));
  GAS_WEB_APP_URL = settings.gasUrl;

  document.getElementById('advice').innerHTML = generateAdvice(data.overallScore);

  if(GAS_WEB_APP_URL){
    showStatus('กำลังส่งข้อมูลไปยัง GAS...');
    try {
      const response = await fetch(GAS_WEB_APP_URL, {
        method:'POST', mode:'cors',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const respJson = await response.json();
      showStatus('ส่งข้อมูลเรียบร้อย', true);
      console.log('GAS response:', respJson);
    } catch(err){
      console.error('GAS fetch error:', err);
      showStatus('ส่งข้อมูลล้มเหลว (CORS/Permission) — บันทึกไว้ในเครื่องแทน', false, true);
      saveLocal();
    }
  } else {
    saveLocal();
    showStatus('บันทึกไว้ที่เครื่อง (localStorage) แล้ว — ตั้งค่า GAS URL หากต้องการส่งขึ้น Google Sheets', true);
  }
}

function showStatus(msg, success=true, isError=false){
  const s = document.getElementById('status'); s.innerText=msg;
  s.className = isError?'error':'muted'; if(success) s.classList.add('success');
  setTimeout(()=>{ if(s) s.innerText=''; }, 6000);
}

function saveLocal(){
  const data = collectForm();
  const prev = JSON.parse(localStorage.getItem('lgs-submissions')||'[]');
  prev.push(data);
  localStorage.setItem('lgs-submissions', JSON.stringify(prev));
  showStatus('บันทึกข้อมูลลง localStorage เรียบร้อย', true);
}

async function testGas(){
  const url = document.getElementById('gasUrl').value.trim();
  if(!url){ alert('โปรดวาง Web App URL ของ GAS ก่อน'); return; }
  try{
    const res = await fetch(url, {method:'GET', mode:'cors'});
    const j = await res.json();
    alert('เชื่อมต่อ GAS สำเร็จ: '+(j.message || JSON.stringify(j)));
    document.getElementById('gasUrl').value = url; GAS_WEB_APP_URL = url;
  } catch(e){
    alert('เชื่อมต่อ GAS ไม่สำเร็จ — ตรวจสอบ CORS / Deploy เป็น Anyone (even anonymous)');
  }
}

function generateAdvice(score){
  const n = Number(score || 0);
  if(n>=80) return `<div class="card"><strong>คะแนน: ${n}% — เยี่ยมมาก!</strong><div class="muted">คุณกำลังเดินตามแผนได้ดี ลองให้รางวัลเล็ก ๆ กับตัวเองดูนะ</div></div>`;
  if(n>=50) return `<div class="card"><strong>คะแนน: ${n}% — ทำได้ดี</strong><div class="muted">ลองปรับแผนเล็กน้อยเพื่อให้ทำต่อเนื่องมากขึ้น</div></div>`;
  return `<div class="card"><strong>คะแนน: ${n}% — อย่าท้อใจ</strong><div class="muted">การวางเป้าหมายใหม่และปรับตามสถานการณ์เป็นเรื่องปกติ คุณยังเริ่มใหม่ได้เสมอ</div></div>`;
}

function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>



  <!--
  -------------------------------
  GOOGLE APPS SCRIPT (GAS) CODE
  -------------------------------
  Paste the following code into a new Google Apps Script project (File > New > Script). Then update the SHEET_ID constant (server-side only) to the Sheet you want to write to. Deploy > New deployment > Select type: Web app > Access: Anyone (even anonymous) if you want public posting.

  IMPORTANT: Keep the SHEET_ID only inside GAS. Do NOT put it into the HTML.

  ---------- GAS CODE (JavaScript) ----------
  */
  // /** GAS code starts here (copy everything between the next comment and the end) */
  /*
  const SHEET_ID = 'PASTE_YOUR_SHEET_ID_HERE'; // <-- set this to your Google Sheet ID (server-side)
  const SHEET_NAME = 'Submissions';

  function doGet(e){
    // simple healthcheck
    return ContentService.createTextOutput(JSON.stringify({message:'GAS OK'})).setMimeType(ContentService.MimeType.JSON);
  }

  function doPost(e){
    try{
      const payload = JSON.parse(e.postData.contents);
      const ss = SpreadsheetApp.openById(SHEET_ID);
      let sheet = ss.getSheetByName(SHEET_NAME);
      if(!sheet) sheet = ss.insertSheet(SHEET_NAME);
      // header row if empty
      if(sheet.getLastRow() === 0){
        sheet.appendRow(['submittedAt','bigGoal','miniGoals_JSON','overallScore','adjustPlan','monthIndex','month_complete','month_percent','month_adjust']);
      }
      // Add one row per month for easy analysis
      const months = payload.months || {};
      const base = [payload.submittedAt || new Date().toISOString(), payload.bigGoal || '', JSON.stringify(payload.miniGoals||[]), payload.overallScore || 0, payload.adjustPlan || ''];
      const rows = [];
      for(const idx in months){
        const m = months[idx];
        rows.push(base.concat([idx, m.complete? 'yes':'no', m.percent||0, m.adjust||'']));
      }
      if(rows.length > 0) sheet.getRange(sheet.getLastRow()+1,1,rows.length, rows[0].length).setValues(rows);
      return ContentService.createTextOutput(JSON.stringify({status:'ok', inserted: rows.length})).setMimeType(ContentService.MimeType.JSON);
    }catch(err){
      return ContentService.createTextOutput(JSON.stringify({status:'error', message: err.message})).setMimeType(ContentService.MimeType.JSON);
    }
  }
  */
-->
</body>
</html> 
